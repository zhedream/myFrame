<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>文件上传</title>
</head>
<body>
<?php view('common.nav') ?>
<h1>设置头像</h1>



<div class="" >

    <form action="" enctype='multipart/form-data' method="POST" id="from">
        <?=csrf_field()?>
        <div class="form-div">
            <input type="file" name="face" id="face">
        </div>
        <div class="form-div">
            <!-- <input type="button" onclick="Comment()" value="确认"> -->
            <button type="button" id="btn">上传</button>
        </div>
        <input type="hidden" name="x" value="">
        <input type="hidden" name="y" value="">
        <input type="hidden" name="w" value="">
        <input type="hidden" name="h" value="">
    </form>

    <div id="log" style="overflow:hidden;"></div>
</div>

<!-- <script src="/js/jquery-3.2.1.min.js"></script> -->
<script src="/js/spark-md5.min.js" type="text/javascript"></script>
<script src="/cropper-4.0.0/cropper.min.js"></script>
<link rel="stylesheet" href="/cropper-4.0.0/cropper.min.css">


<script>


    // 每个文件切片大小定为1M(1024*1024字节)(需要跟服务器协商好).
    // var BYTES_PER_SLICE = 2<<20;
    var BYTES_PER_SLICE = 1024 * 128;
    // 已发送的数量
    var hasSendNum = 0;
    // 总切片数
    var totalSlices;


    $('#btn').click(function () {

        // 拿出选中的第一个文件
        input = document.getElementById('face');
        var file = input.files[0];
        console.log(file);
        // return;

        // 文件的总字节数
        var totalSize = file.size;
        // 当前片数
        var index = 0;
        // 分片的开始、结束（不含）
        var start, end;
        // 文件名
        var fileName = file.name;
        // 文件后缀类型
        var fileType = str_LastType(file.name);
        console.log('name:', fileName);

        // 初始化已发送数量为0
        hasSendNum = 0;

        // 计算文件切片总数（向上取整）
        totalSlices = Math.ceil(file.size / BYTES_PER_SLICE);


        compute(input);

        async function compute(input) {
            var MD5 = await getMd5(input);
            console.log('fileMD5:', MD5);

            $.ajax({
                url: "/user/readyfile?MD5=" + MD5,
                type: 'get',
                dataType: "json",
                success: function (data) {
                    if (data.err == 1) {
                        console.log('秒传', data.data);

                        return;
                    } else if (data.err == 2) {
                        console.log('断点续传', data.data);

                        console.log(data.data.indexOf((String)(0)));
                        // return ;

                        while (index < totalSlices) {
                            console.log(index+'。');
                            if(data.data.indexOf((String)(index))!=-1){
                                index++;
                                
                                continue ;
                            }

                            // return ;
                            console.log('当前分片', MD5 + '_' + totalSlices + '_' + (index));
                            start = index * BYTES_PER_SLICE;
                            end = start + BYTES_PER_SLICE;

                            var slice = file.slice(start, end);//切割文件

                            var formData = new FormData($("#from"));

                            formData.append("slice", slice);
                            formData.append("fileName", fileName);
                            formData.append("fileType", fileType);
                            formData.append("index", index++);
                            formData.append("MD5", MD5);
                            formData.append("totalSlices", totalSlices);
                            formData.append("curSlice", MD5 + '_' + totalSlices + '_' + index);


                            upload(index, formData)

                            $.ajax({
                                url: "/user/avatar/" + index,
                                data: formData,
                                type: 'post',
                                // dataType:"json",
                                // async : false,
                                cache: false,
                                processData: false,
                                contentType: false,
                                //contentType : "application/json; charset=utf-8",
                                success: function (data) {

                                }, error: function (data) {
                                    // console.log(data);
                                }
                            });

                        }


                    } else if (data.err == 3) {
                        console.log('完整上传');

                        while (index < totalSlices) {

                            console.log('当前分片', MD5 + '_' + totalSlices + '_' + (index + 1));
                            start = index * BYTES_PER_SLICE;
                            end = start + BYTES_PER_SLICE;

                            var slice = file.slice(start, end);//切割文件

                            var formData = new FormData($("#from"));

                            formData.append("slice", slice);
                            formData.append("fileName", fileName);
                            formData.append("fileType", fileType);
                            formData.append("index", index++);
                            formData.append("MD5", MD5);
                            formData.append("totalSlices", totalSlices);
                            formData.append("curSlice", MD5 + '_' + totalSlices + '_' + index);


                            upload(index, formData)

                            $.ajax({
                                url: "/user/avatar/" + index,
                                data: formData,
                                type: 'post',
                                // dataType:"json",
                                // async : false,
                                cache: false,
                                processData: false,
                                contentType: false,
                                //contentType : "application/json; charset=utf-8",
                                success: function (data) {

                                }, error: function (data) {
                                    // console.log(data);
                                }
                            });

                        }


                    }

                }, error: function (data) {
                    // console.log(data);
                }
            });


            // async
        }


    })


    function upload() {


    }

    function str_LastType(str) {
        "use strict";
        var loc = str.lastIndexOf(".");
        var a = str.substr(loc + 1);
        return a;

    }

</script>

<script type="text/javascript">
    var blobSlice = File.prototype.slice || File.prototype.mozSlice || File.prototype.webkitSlice,
        log = document.getElementById('log'),

        running = false,
        ua = navigator.userAgent.toLowerCase();
    MD5 = '';

    function registerLog(str, className) {
        var elem = document.createElement('div');

        elem.innerHTML = str;
        // elem.className = 'alert-message' + (className ? ' '  + className : '');
        $(log).empty()
        log.appendChild(elem);
    }

    function getMd5(input) {

        return new Promise(
            function (resolve) {
                if (running) {
                    return;
                }

                if (!input.files.length) {
                    registerLog('<strong>Please select a file.</strong><br/>');
                    return;
                }

                var blobSlice = File.prototype.slice || File.prototype.mozSlice || File.prototype.webkitSlice,
                    file = input.files[0],
                    chunkSize = 2097152,                           // read in chunks of 2MB
                    chunks = Math.ceil(file.size / chunkSize),
                    currentChunk = 0,
                    spark = new SparkMD5.ArrayBuffer(),
                    time,
                    uniqueId = 'chunk_' + (new Date().getTime()),
                    perId = 'per_' + (new Date().getTime()),
                    chunkId = null,
                    per = null,
                    fileReader = new FileReader();

                fileReader.onload = function (e) {
                    if (currentChunk === 0) {
                        // registerLog('文件检查 <strong id="' + uniqueId + '">' + (currentChunk + 1) + '</strong> of <strong>' + chunks + '</strong><br/>', 'info');
                        // registerLog('文件检查 <strong id="' + uniqueId + '">' + (currentChunk) + '</strong> of <strong>' + chunks + '</strong><br> <span id="' + perId + '" >' + currentChunk / chunks * 100 + '</span>   <br/>', 'info');
                        registerLog('文件检查 <span id="' + perId + '" >' + currentChunk / chunks * 100 + '</span>   <br/>', 'info');

                    } else {
                        if (per === null) {
                            // chunkId = document.getElementById(uniqueId);
                            per = document.getElementById(perId);
                        }

                        // console.log('文件检查 <strong id="' + uniqueId + '">' + (currentChunk) + '</strong> of <strong>' + chunks + '</strong><br><br> <span id="'+perId+'" >'+currentChunk/chunks*100+'</span>   <br/>', 'info');
                        // chunkId.innerHTML = currentChunk + 1;
                        per.innerHTML = ((currentChunk + 1) / chunks * 100).toFixed(2) + "%";

                    }

                    spark.append(e.target.result);                 // append array buffer
                    currentChunk += 1;

                    if (currentChunk < chunks) {
                        loadNext();
                    } else {
                        running = false;
                        // registerLog('<strong>Finished loading!</strong><br/>', 'success');
                        MD5 = spark.end();
                        registerLog('<strong>文件MD5:</strong> ' + MD5 + '<br/>', 'success'); // compute hash
                        resolve(MD5);
                    }

                };

                fileReader.onerror = function () {
                    running = false;
                    registerLog('<strong>Oops, something went wrong.</strong>', 'error');
                };

                function loadNext() {
                    var start = currentChunk * chunkSize,
                        end = start + chunkSize >= file.size ? file.size : start + chunkSize;

                    fileReader.readAsArrayBuffer(blobSlice.call(file, start, end));
                }

                running = true;
                registerLog('<p></p><strong>Starting incremental test (' + file.name + ')</strong><br/>', 'info');
                time = new Date().getTime();
                loadNext();
            }
        )
    }


    function clearLog() {
        if (!running) {
            log.innerHTML = '';
        }
    }

    if (!('FileReader' in window) || !('File' in window) || !blobSlice) {
        registerLog('<p><strong>Your browser does not support the FileAPI or slicing of files.</strong></p>', 'error');
    } else {
        registerLog('Keep your devtools closed otherwise this example will be a LOT slower', 'info');

        if (/chrome/.test(ua)) {
            if (location.protocol === 'file:') {
                registerLog('<p><strong>This example might not work in chrome because you are using the file:// protocol.</strong><br/>You can try to start chrome with -allow-file-access-from-files argument or spawn a local server instead. This is a security measure introduced in chrome, please <a target=\'_blank\' href=\'http://code.google.com/p/chromium/issues/detail?id=60889\'>see</a>.</p>');
            }
        }

        // document.getElementById('incremental').addEventListener('click', doIncrementalTest());

        // document.getElementById('clear').addEventListener('click', clearLog);
    }
</script>

<?php view('common.footer') ?>
</body>
</html>