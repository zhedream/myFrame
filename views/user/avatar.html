<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>设置头像</title>
</head>
<body>
<?php view('common.nav') ?>
<h1>设置头像</h1>

<style>
    .img-container {
        width: 300px;
        height: 300px;
        float: left;
    }

    .img-preview {
        float: left;
        overflow: hidden;
        margin-left: 20px;
    }

    .preview-lg {
        width: 240px;
        height: 240px;
    }

    .preview-md {
        width: 80px;
        height: 80px;
    }

    .preview-sm {
        width: 35px;
        height: 35px;
    }
</style>

<div class="">
    <div style="clear:both;overflow: hidden;">


        <div class="img-container">
            <img id="image" src="<?=$_SESSION['avatar']?>" alt="头像">
        </div>
        <div class="docs-preview clearfix" style="overflow: hidden;">
            <div class="img-preview preview-lg"></div>
            <div class="img-preview preview-md"></div>
            <!-- <div class="img-preview preview-sm"></div> -->
        </div>
    </div>
    <hr>
    <form action="" enctype='multipart/form-data' method="POST" id="from">
        <?=csrf_field()?>
        <div class="form-div">
            <input type="file" name="face" id="face" accept="image/*">
        </div>
        <div class="form-div">
            <!-- <input type="button" onclick="Comment()" value="确认"> -->
            <button type="button" id="btn">上传</button>
        </div>
        <input type="hidden" name="x" value="">
        <input type="hidden" name="y" value="">
        <input type="hidden" name="w" value="">
        <input type="hidden" name="h" value="">
    </form>

    <div id="log" style="overflow:hidden;"></div>
</div>

<!-- <script src="/js/jquery-3.2.1.min.js"></script> -->
<!-- <script src="/js/spark-md5.min.js" type="text/javascript"></script>
<script src="/cropper-4.0.0/cropper.min.js"></script>
<link rel="stylesheet" href="/cropper-4.0.0/cropper.min.css"> -->
<?=includeJs("js/spark-md5.min.js")?>
<?=includeJs("cropper-4.0.0/cropper.min.js")?>
<?=includeCss("cropper-4.0.0/cropper.min.css")?>


<script>
    // 获取图片

    // 启动 cropper 插件
    var x = $('input[name=x]')
    var y = $('input[name=y]')
    var w = $('input[name=w]')
    var h = $('input[name=h]')
    pass = null;
    $('input[name=face]').change(function () {
        input = document.getElementById('face');
        var image = $('#image');
        var url = getObjectUrl(this.files[0]);
        console.log(url);

        var type = this.files[0].type;
        // console.log('type:',type);
        var type = type.match(/^image\/(.*)$/) != null ? type.match(/^image\/(.*)$/)[1] : null;
        console.log('type:', type);

        Array.prototype.exists = function (val) {
            for (var i = 0; i < this.length; i++)
                if (this[i] == val)
                    return true;
            return false;
        }

        pass = ['jpeg', 'jpg', 'png'].exists(type);
        if (!pass) {
            console.log('false');
            image.cropper("destroy");
            $(image).attr("src", '');
            $(image).attr("alt", '请选择正确的图片');
            return;
        }
        console.log('true');

        var image = $('#image');
        image.attr('src', url);
        image.cropper("destroy");
        image.cropper({
            aspectRatio: 1,         // 缩略图1:1的比例
            preview: '.img-preview',    // 显示缩略图的框
            viewMode: 3,
            // 裁切时触发事件·
            crop: function (event) {
                x.val(event.detail.x);             // 裁切区域左上角x坐标
                y.val(event.detail.y);             // 裁切区域左上角y坐标
                w.val(event.detail.width);         // 裁切区域宽高
                h.val(event.detail.height);        // 裁切区域高度
            }
        });

    })

    function getObjectUrl(file) {
        var url = null;
        if (window.createObjectURL != undefined) {
            url = window.createObjectURL(file)
        } else if (window.URL != undefined) {
            url = window.URL.createObjectURL(file)
        } else if (window.webkitURL != undefined) {
            url = window.webkitURL.createObjectURL(file)
        }
        return url
    }



    $('#btn').click(function () {

        if (!pass) {
            alert('请选择正确的图片')
            console.log('请选择正确的图片');
            return false;
        }

        pass = false
        // 拿出选中的第一个文件
        input = document.getElementById('face');
        var file = input.files[0];
        console.log(file);
        // return;

        // 文件的总字节数
        var totalSize = file.size;
        console.log(totalSize);
        
        // 文件名
        var fileName = file.name;
        // 文件后缀类型
        var fileType = str_LastType(file.name);
        console.log('name:', fileName);

        var formData = new FormData(from);

        formData.append("face", file);
        formData.append("fileName", Math.random());
        formData.append("fileType", fileType);
        $.ajax({
            url: "/user/avatar?a="+Math.random(),
            data: formData,
            type: 'POST',
            dataType:"json",
            // async : false,
            // cache: false,
            processData: false,
            contentType: false,
            //contentType : "application/json; charset=utf-8",
            success: function (data) {
                var image = $('#image');
                console.log(image);
            image.attr('src', data.url);
                
            }, error: function (data) {
                // console.log(data);
            }
        });

        from.reset();
        var image = $('#image');
        image.cropper("destroy");
        // async


    })

    function str_LastType(str) {
        "use strict";
        var loc = str.lastIndexOf(".");
        var a = str.substr(loc + 1);
        return a;

    }

</script>
     
<script type="text/javascript">
    var blobSlice = File.prototype.slice || File.prototype.mozSlice || File.prototype.webkitSlice,
        log = document.getElementById('log'),

        running = false,
        ua = navigator.userAgent.toLowerCase();
    MD5 = '';

    function registerLog(str, className) {
        var elem = document.createElement('div');

        elem.innerHTML = str;
        // elem.className = 'alert-message' + (className ? ' '  + className : '');
        $(log).empty()
        log.appendChild(elem);
    }

    // 异步函数
    function getMd5(input) {

        return new Promise(
            function (resolve) {
                if (running) {
                    return;
                }

                if (!input.files.length) {
                    // registerLog('<strong>Please select a file.</strong><br/>');
                    return;
                }

                var blobSlice = File.prototype.slice || File.prototype.mozSlice || File.prototype.webkitSlice,
                    file = input.files[0],
                    chunkSize = 2097152,                           // read in chunks of 2MB
                    chunks = Math.ceil(file.size / chunkSize),
                    currentChunk = 0,
                    spark = new SparkMD5.ArrayBuffer(),
                    time,
                    uniqueId = 'chunk_' + (new Date().getTime()),
                    perId = 'per_' + (new Date().getTime()),
                    chunkId = null,
                    per = null,
                    fileReader = new FileReader();

                fileReader.onload = function (e) {
                    if (currentChunk === 0) {
                        // registerLog('文件检查 <strong id="' + uniqueId + '">' + (currentChunk + 1) + '</strong> of <strong>' + chunks + '</strong><br/>', 'info');
                        // registerLog('文件检查 <strong id="' + uniqueId + '">' + (currentChunk) + '</strong> of <strong>' + chunks + '</strong><br> <span id="' + perId + '" >' + currentChunk / chunks * 100 + '</span>   <br/>', 'info');
                        registerLog('文件检查 <span id="' + perId + '" >' + currentChunk / chunks * 100 + '</span>   <br/>', 'info');

                    } else {
                        if (per === null) {
                            // chunkId = document.getElementById(uniqueId);
                            per = document.getElementById(perId);
                        }

                        // console.log('文件检查 <strong id="' + uniqueId + '">' + (currentChunk) + '</strong> of <strong>' + chunks + '</strong><br><br> <span id="'+perId+'" >'+currentChunk/chunks*100+'</span>   <br/>', 'info');
                        // chunkId.innerHTML = currentChunk + 1;
                        per.innerHTML = ((currentChunk + 1) / chunks * 100).toFixed(2) + "%";

                    }

                    spark.append(e.target.result);                 // append array buffer
                    currentChunk += 1;

                    if (currentChunk < chunks) {
                        loadNext();
                    } else {
                        running = false;
                        // registerLog('<strong>Finished loading!</strong><br/>', 'success');
                        MD5 = spark.end();
                        registerLog('<strong>文件MD5:</strong> ' + MD5 + '<br/>', 'success'); // compute hash
                        resolve(MD5); // 返回异步数据
                    }

                };

                fileReader.onerror = function () {
                    running = false;
                    // registerLog('<strong>Oops, something went wrong.</strong>', 'error');
                };

                function loadNext() {
                    var start = currentChunk * chunkSize,
                        end = start + chunkSize >= file.size ? file.size : start + chunkSize;

                    fileReader.readAsArrayBuffer(blobSlice.call(file, start, end));
                }

                running = true;
                registerLog('<p></p><strong>Starting incremental test (' + file.name + ')</strong><br/>', 'info');
                time = new Date().getTime();
                loadNext();
            }
        )
    }


    function clearLog() {
        if (!running) {
            log.innerHTML = '';
        }
    }

    if (!('FileReader' in window) || !('File' in window) || !blobSlice) {
        // registerLog('<p><strong>Your browser does not support the FileAPI or slicing of files.</strong></p>', 'error');
    } else {
        // registerLog('Keep your devtools closed otherwise this example will be a LOT slower', 'info');

        if (/chrome/.test(ua)) {
            if (location.protocol === 'file:') {
                // registerLog('<p><strong>This example might not work in chrome because you are using the file:// protocol.</strong><br/>You can try to start chrome with -allow-file-access-from-files argument or spawn a local server instead. This is a security measure introduced in chrome, please <a target=\'_blank\' href=\'http://code.google.com/p/chromium/issues/detail?id=60889\'>see</a>.</p>');
            }
        }
    }
</script>

<?php view('common.footer') ?>
</body>
</html>