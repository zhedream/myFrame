<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title><?=$blog['title']?></title>
    <?=includeCss('css/content.css')?>
</head>
<body style="display:none;">
    <?php view('common.nav',['_static'=>isset($_static)?$_static:'']) ?>

        阅读量: <span id="display"><?=$blog['display']?></span>
        点赞量：<span id="heart"><?=$blog['heart']?></span> <button type="button" onclick="agree()">赞一下</button> <hr>
        <?=hpe($blog['content'])?>
        
        <div class="agree-list">
            <h3>点赞TOP10<span style="font-size:12px;">(60秒更新一次)</span></h3> 
            <div id="avatar-list">
                <!-- 静态页 -->
                
                <?php if(!isset($_static)):?>

                    <?php foreach($heartTop as $user):?>
                        <img title="<?=$user['email']?>" class="avatar" src="<?=$user['avatar']?>" alt="">
                    <?php endforeach;?>

                <?php endif;?>

            </div>
        </div>

        <div id="comment_app">

                <h3>评论列表</h3>
        
                <div v-for="(v,k) in comments" class="comment-list">
                    <div class="left">
                        <img :src="v.avatar" width="50" height="50">
                        <p> {{ v.email }} </p>
                    </div>
                    <div class="right">
                        <div class="con">
                            {{ v.content }}
                        </div>
                        <div class="date">
                            {{ v.created_at }}
                        </div>
                    </div>
                    <div class="clearfix"></div>
                </div>
        
                <br><br>
                <form action="">
                    <textarea v-model="content" cols="60" rows="10"></textarea>
                    <br>
                    <input @click="submit" type="button" value="发表评论">
                </form>
        
            </div>
        
    <?php view('common.footer') ?>
</body>
</html>

<script>

    var token = "";

    function agree(){
        // console.log('_token',token); 
        
        var fromdata = new FormData;
        fromdata.append('_token',token)

        var url = "<?=Route('blog.agree',['id'=>$blog['id']])?>"
            $.ajax({
                type:"post",
                url:url,
                data:fromdata,
                dataType: "json",
                processData: false,
                contentType: false,
                success:function(data){
                    // console.log(data);
                    if(data.err == 1)
                        $("#heart").html(data.count);
                    else
                        alert('登陆信息已失效，请重新登陆')

                }
            })
    }

$(function(){

var id = "<?=$blog['id']?>";
// 定义接口地址
var url = "/blog/display/" + id;
// 请求这个地址
$.ajax({
    type:"GET",
    url:url,
    dataType: "json",
    success:function(data)
    {
        // console.log('increat:',data);
        
        // 把返回的浏览量放到页面
        $("#display").html(data.display);
        $("#heart").html(data.heart);
        token = data.token;
        var memu = document.getElementById('memu_static');
        // console.log(memu);
        if(memu){
            console.log('TRUE:这是静态页');
            var html = '<a href="/">首页</a>';
            // 判断登录
            if(data.email == '' || data.email==null)
            {
                html += ` <a href="<?=Route('user.regist')?>">注册</a>
                        <a href="<?=Route('user.login')?>">登录</a>`;
            }
            else
            {
                html += data.email +
                        `
                        <img src="`+data.avatar+`" alt="">
                        <a href="<?=Route('user.recharge') ?>">充值</a> 
                        <a href="<?=Route('blog.index') ?>">日志列表</a> 
                        <a href="<?=Route('blog.create') ?>">发表日志</a> 
                        <a href="<?=Route('user.logout') ?>">退出</a>`;
            }
            $(memu).html(html);

            var html = '';
            console.log(data.heartTop);
            
            for(var i=0; i<data.heartTop.length; i++)
            {
                var avatar = data.heartTop[i].avatar ? data.heartTop[i].avatar : '/images/avatar.jpg';
                html += '<img title="'+data.heartTop[i].email+'" class="avatar" src="'+avatar+'" alt="">';
            }
            // 把字符串放到页面
            $("#avatar-list").html( html )

        }
        else{
            console.log('FALSE:这是动态页');

        }
    },
    error:function(){
        console.log('格式错误');

    }
});

})
</script>

<script src="https://cdn.jsdelivr.net/npm/vue"></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>

<script>

var app = new Vue({
    // 挂载
    el:"#comment_app",
    // 定义数据
    data:{
        content:'',
        blog_id:"<?=$blog['id']?>",
        // 评论列表数据
        comments:[]
    },
    // 在创建完 Vue 之后执行
    created: function(){
        // 获取初始数据
        axios.get("<?=Route('blog.comment',['id'=>$blog['id']])?>")
             .then(res => {
                 if( res.data)
                 {
                     // 把服务器返回的数据放到绑定的数组上，会自动更新到页面
                     this.comments = res.data
                 }
             })
    },
    // 定义函数
    methods: {
        submit : function(){
            // 执行 AJAX 发表评论
            axios.post('/comment/comments', {
                content: this.content,
                blog_id: this.blog_id
            })
            .then(res => {
                // AJAX 执行完之后执行这里
                if(res.data.status_code == 200)
                {
                    // 把新发表的添加到数组中的最前面
                    this.comments.unshift({
                        email:res.data.data.email,
                        content:res.data.data.content,
                        created_at:res.data.data.created_at,
                        avatar:res.data.data.avatar
                    })
                    // 清空数据
                    this.content = ''
                }
                else
                {
                    alert(res.data.message)
                }
            })
        }
    }
});


</script>